<!DOCTYPE html>
<html>
<head>
<title>Bellevue Portals</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
html { height: 100% }
body { height: 100%; margin: 0; padding: 0 }
</style>
<script type="text/javascript">
var portal = [
[47.614546,-122.217562],
[47.614277,-122.217872],
[47.615073,-122.217261],
[47.617134,-122.211359],
[47.617511,-122.207727],
[47.626384,-122.206923],
[47.626619,-122.206279],
[47.631882,-122.208883],
[47.631868,-122.208563],
[47.631771,-122.208595],
[47.631679,-122.208507],
[47.635549,-122.207186],
[47.642216,-122.199333],
[47.643703,-122.19648],
[47.644423,-122.195543],
[47.660673,-122.164296],
[47.660456,-122.153331],
[47.657134,-122.143459],
[47.65465,-122.143491],
[47.652666,-122.143464],
[47.648453,-122.143319],
[47.647675,-122.1433],
[47.647335,-122.144233],
[47.647654,-122.145343],
[47.64144,-122.147191],
[47.640365,-122.1475],
[47.634957,-122.14436],
[47.631788,-122.143756],
[47.631661,-122.143336],
[47.630465,-122.143351],
[47.628948,-122.14586],
[47.629342,-122.147368],
[47.628835,-122.149133],
[47.627663,-122.138967],
[47.627729,-122.138168],
[47.630686,-122.133439],
[47.631344,-122.131974],
[47.638622,-122.119104],
[47.641011,-122.11443],
[47.645472,-122.113217],
[47.636716,-122.115505],
[47.636737,-122.1158],
[47.636274,-122.115591],
[47.635841,-122.115791],
[47.634989,-122.115087],
[47.63137,-122.112241],
[47.623911,-122.091115],
[47.621509,-122.098898],
[47.597497,-122.11367],
[47.595314,-122.111383],
[47.592218,-122.112275],
[47.573847,-122.111206],
[47.571311,-122.106063],
[47.55219,-122.105203],
[47.54403,-122.10036],
[47.544192,-122.103462],
[47.545061,-122.115722],
[47.538429,-122.117225],
[47.537071,-122.112492],
[47.541424,-122.119596],
[47.541891,-122.120336],
[47.540434,-122.124744],
[47.543541,-122.130447],
[47.545438,-122.147129],
[47.54898,-122.156188],
[47.549504,-122.15704],
[47.550055,-122.15718],
[47.550445,-122.158543],
[47.5499,-122.15945],
[47.5505,-122.163326],
[47.549048,-122.169032],
[47.54104,-122.174449],
[47.545832,-122.185197],
[47.549502,-122.185691],
[47.557151,-122.189296],
[47.557361,-122.190727],
[47.563972,-122.187283],
[47.564418,-122.188376],
[47.565227,-122.187764],
[47.566147,-122.19062],
[47.565613,-122.190998],
[47.565697,-122.191399],
[47.565455,-122.19142],
[47.571183,-122.181748],
[47.57395,-122.187879],
[47.574446,-122.187867],
[47.578875,-122.197425],
[47.579282,-122.19688],
[47.579458,-122.196615],
[47.579443,-122.195103],
[47.580386,-122.195008],
[47.580364,-122.196427],
[47.58593,-122.195266],
[47.5869,-122.196755],
[47.587992,-122.197419],
[47.588037,-122.20463],
[47.59318,-122.20122],
[47.596335,-122.197899],
[47.599743,-122.210451],
[47.599833,-122.210704],
[47.600078,-122.210194],
[47.600148,-122.20865],
[47.607437,-122.205553],
[47.608864,-122.206946],
[47.609576,-122.208679],
[47.610378,-122.209981],
[47.61115,-122.211181],
[47.611295,-122.211449],
[47.611406,-122.211701],
[47.616978,-122.220693],
[47.619544,-122.205543],
[47.65479,-122.164465],
[47.647667,-122.16465],
[47.646726,-122.164572],
[47.646238,-122.164367],
[47.646097,-122.164623],
[47.640332,-122.162001],
[47.637134,-122.162021],
[47.633299,-122.179197],
[47.632681,-122.17944],
[47.641241,-122.192079],
[47.641089,-122.191139],
[47.640713,-122.191503],
[47.549254,-122.180358],
[47.548946,-122.18011],
[47.548158,-122.180487],
[47.546982,-122.174044],
[47.550846,-122.163615],
[47.551984,-122.164725],
[47.551339,-122.175626],
[47.551916,-122.17772],
[47.551997,-122.178961],
[47.550701,-122.179546],
[47.553574,-122.166074],
[47.553721,-122.166414],
[47.554109,-122.166998],
[47.555149,-122.167418],
[47.565202,-122.170876],
[47.565074,-122.170334],
[47.567324,-122.169927],
[47.566674,-122.166767],
[47.566314,-122.165523],
[47.567558,-122.168374],
[47.567765,-122.167755],
[47.568108,-122.168616],
[47.568051,-122.167777],
[47.568514,-122.16826],
[47.568568,-122.169326],
[47.568826,-122.168825],
[47.56904,-122.168698],
[47.56847,-122.166205],
[47.568513,-122.165397],
[47.568928,-122.16846],
[47.568826,-122.168825]
];
var portalCount = portal.length;
var mapInitialized=false;

// https://github.com/indy256/convexhull-js/blob/master/convexhull.js
(function () {
    'use strict';

    function convexHull(points) {
        points.sort(function (a, b) {
            return a.x != b.x ? a.x - b.x : a.y - b.y;
        });

        var n = points.length;
        var hull = [];

        for (var i = 0; i < 2 * n; i++) {
            var j = i < n ? i : 2 * n - 1 - i;
            while (hull.length >= 2 && removeMiddle(hull[hull.length - 2], hull[hull.length - 1], points[j]))
                hull.pop();
            hull.push(points[j]);
        }

        hull.pop();
        return hull;
    }

    function removeMiddle(a, b, c) {
        var cross = (a.x - b.x) * (c.y - b.y) - (a.y - b.y) * (c.x - b.x);
        var dot = (a.x - b.x) * (c.x - b.x) + (a.y - b.y) * (c.y - b.y);
        return cross < 0 || cross == 0 && dot <= 0;
    }

    // export as AMD module / Node module / browser or worker variable
    if (typeof define === 'function' && define.amd) define(function () { return convexHull; });
    else if (typeof module !== 'undefined') module.exports = convexHull;
    else if (typeof self !== 'undefined') self.convexHull = convexHull;
    else window.convexHull = convexHull;
})();

function initializeMap() 
{
    if (!mapInitialized)
    {
        
        var mapOptions = { center: new google.maps.LatLng(47.65, -122.10),
                            zoom: 10,
                            mapTypeId: google.maps.MapTypeId.ROADMAP };
        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
        mapInitialized=true;    
        
        /*
        for (var i = 0; i < portalCount; i++) {
            var circle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: {lat: portal[i][0], lng: portal[i][1]},
                radius: 40
            });
        }
        */
        
        /*
        // Find a rectangle (just as a test of using lat/long instead of projecting)
        var closest = 1000;
        var rectangle = [0,1,2,3];
        for (var i=0; i<portalCount;i++){
            for (var j=0; j<portalCount;j++){
                if (j==i) continue;
                for (var k=0;k<portalCount;k++){
                    if (k==i || k==j) continue;
                    for (var l=0;l<portalCount;l++){
                        if (l==i || l==j || l==k) continue;
                        // we want the closest i.x == j.x, k.x == l.x, i.y == k.y, j.y == l.y
                        // for rect i, j, l, k(, i)
                        var maxError = Math.max(
                            Math.abs(portal[i][0] - portal[j][0]),
                            Math.abs(portal[k][0] - portal[l][0]),
                            Math.abs(portal[i][1] - portal[k][1]),
                            Math.abs(portal[j][1] - portal[l][1]));
                        if (maxError < closest) {
                            closest = maxError;
                            rectangle = [i,j,k,l];
                        }
                        
                    }
                }
            }
        }

        // Draw the rectangle
        var polyline = new google.maps.Polyline({
                path: [
                {lat: portal[rectangle[0]][0], lng: portal[rectangle[0]][1]},
                {lat: portal[rectangle[1]][0], lng: portal[rectangle[1]][1]},
                {lat: portal[rectangle[3]][0], lng: portal[rectangle[3]][1]},
                {lat: portal[rectangle[2]][0], lng: portal[rectangle[2]][1]},
                {lat: portal[rectangle[0]][0], lng: portal[rectangle[0]][1]}
                ],
                strokeColor: "#FF00FF",
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map});
 
        */

        // What I want is...
        //                     A
        // B                                       C
        //           D                   E
        //                     F
        //           G                   H
        // I                                       J
        //                     K
        //
        // A = (56,   0) => (14,  0)
        // B = (0,   32) => ( 0,  8)
        // C = (112, 32) => (28,  8)
        // D = (28,  48) => ( 7, 12)
        // E = (84,  48) => (21, 12)
        // F = (56,  64) => (14, 16)
        // G = (28,  80) => ( 7, 20)
        // H = (84,  80) => (21, 20)
        // I = (0,   96) => ( 0, 24)
        // J = (112, 96) => (28, 24)
        // K = (56, 128) => (14, 32)
        
        // Concentric convex hulls would be a good start.  ABCIJK are on an outer hull.  DEGH an inner hull.  F is a center point.
        // Outlying points can be discarded to get the right shape.
        
        // Or... maybe it's not convex hulls, maybe it's finding colinear points BDFHJ and CEFGI (each 8.06 units apart)and AFK (each 16 units apart)
        // sqrt(7^2 + 4^2) = sqrt(65) = sqrt(5*13) = 8.0622577483-ish
        // It would probably look right if AFK distances were just double the other distances.
        // Or use squared distances of 65 and 256.  (64 and 256 would be 4 times the squared distance)
        
        // a latitude difference of 0.000068 looks pretty level (horizontal line)
        
        // Angle of BDFHJ
        // dx = 7, dy = 4
        // latitude increases to the north (around here) and longitude increases to the east
        // so from B to D, we want lat to decrease and lng to increase and we want the lat/long ratio to be 4/7 or the long/lat ratio to be 7/4 = 1.75
        
        // How do we find in our point soup, 5 equally spaced points with dlong/dlat = 1.75?
        // Maybe first find all the points with the right relative slope, partition the set into sets of parallel lines
        
        // The grouping would be... y-intercept.  longitude intercept
        // Given a point, 47.566674,-122.166767
        // The line through it with decreasing latitude and increasing (to 0) longitude with slope 7/4 intercepts (ignoring reality) long=0 
        // at lat = 47.566674 - 4*(122.166767/7) = -22.24290714, so we'd group it with other points that have a long intercept of approx -22.2429
        
        // Then the whole problem can by solved by grouping the points into 3 grouping schemes.  The BDFHJ angle, the CEFGI angle and by equal longitude (AFK).
        // Then... find the best F.
        
        var BDFHJ = {};
        var CEFGI = {};
        var AFK = {};
        
        for (var p=0; p < portalCount; p++) {
            var intercept = (portal[p][0] + (4.0*portal[p][1]/7.0)).toFixed(4);
            if (intercept in BDFHJ) {
                BDFHJ[intercept].push(portal[p]);
            }
            else {
                BDFHJ[intercept] = [portal[p]];
            }
        }
        for (list in BDFHJ) {
            if (BDFHJ[list].length > 1) {
                BDFHJ[list].sort();
                linePoints = BDFHJ[list].map(function (item) {
                    return new google.maps.LatLng(item[0], item[1]);
                });            

                var polyLine = new google.maps.Polyline({
                    path: linePoints,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map
                });    
            }                
            for (point in BDFHJ[list]) {
                marker = new google.maps.Marker({
                    map: map,
                    position: new google.maps.LatLng(BDFHJ[list][point][0], BDFHJ[list][point][1])
                });
            }
        }
        
        for (var p=0; p < portalCount; p++) {
            var intercept = (portal[p][0] - (4.0*portal[p][1]/7.0)).toFixed(4); 
            if (intercept in CEFGI) {
                CEFGI[intercept].push(portal[p]);
            }
            else {
                CEFGI[intercept] = [portal[p]];
            }
        }
        for (list in CEFGI) {
            if (CEFGI[list].length > 1) {
                CEFGI[list].sort();
                linePoints = CEFGI[list].map(function (item) {
                    return new google.maps.LatLng(item[0], item[1]);
                });            

                var polyLine = new google.maps.Polyline({
                    path: linePoints,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map
                });    
            }                
        }        

        for (var p=0; p < portalCount; p++) {
            var intercept = portal[p][1].toFixed(4); 
            if (intercept in AFK) {
                AFK[intercept].push(portal[p]);
            }
            else {
                AFK[intercept] = [portal[p]];
            }
        }
        for (list in AFK) {
            if (AFK[list].length > 1) {
                AFK[list].sort();
                linePoints = AFK[list].map(function (item) {
                    return new google.maps.LatLng(item[0], item[1]);
                });            

                var polyLine = new google.maps.Polyline({
                    path: linePoints,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map
                });    
            }                
        }  
        
        /* CONVEX HULLERY
        var label = 0;
        var labels = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        
        while (portalCount > 1) {
            var pointArray = portal.map(function (item) {
                var obj = {};
                obj['x'] = item[0];
                obj['y'] = item[1];
                return obj;            
            }); 
            var hullPoints = convexHull(pointArray);
            // the first point in the list is in the bottom right (SE) corner of the hull
            // points follow in counterclockwise order
            
            // Remove these points from the portal set for the next pass of convex hullery
            for( var i=portalCount - 1; i>=0; i--){
                for( var j=0; j<hullPoints.length; j++){
                    if(portal[i][0] == hullPoints[j].x && portal[i][1] == hullPoints[j].y){
                        portal.splice(i, 1);
                        portalCount--;
                        j = hullPoints.length;
                    }
                }
            }
            
            //Convert to google latlng objects
            hullPoints = hullPoints.map(function (item) {
                return new google.maps.LatLng(item.x, item.y);
            });

            
            var polyHull = new google.maps.Polygon({
                paths: hullPoints,
                strokeColor: '#000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#000',
                fillOpacity: 0.1
            });

            polyHull.setMap(map);   
            
            
            for (var j=0; j<hullPoints.length; j++){
                var lat = hullPoints[j].lat().toString();
                var lng = hullPoints[j].lng().toString();
                var mapLat = (lat + .001).toString();
                var mapLng = (lng - .001).toString();
                var url = 'https://www.ingress.com/intel?ll=' + mapLat + ',' + mapLng + '&z=17&pll=' + lat + ',' + lng

                var marker;
                
                if (j==0) {
                    var pinColor = "75FE69";
                    var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=" + labels[label % labels.length] + "|" + pinColor,
                        new google.maps.Size(21, 34),
                        new google.maps.Point(0,0),
                        new google.maps.Point(10, 34));
                    marker = new google.maps.Marker({
                        map: map,
                        position: hullPoints[j],
                        title: url,
                        url: url,
                        icon: pinImage
                    });
                }
                else if (j==1) {
                    var pinColor = "7569FE";
                    var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=" + labels[label % labels.length] + "|" + pinColor,
                        new google.maps.Size(21, 34),
                        new google.maps.Point(0,0),
                        new google.maps.Point(10, 34));
                    marker = new google.maps.Marker({
                        map: map,
                        position: hullPoints[j],
                        title: url,
                        url: url,
                        icon: pinImage
                    });                
                }
                else {
                
                    marker = new google.maps.Marker({
                        map: map,
                        position: hullPoints[j],
                        label: labels[label % labels.length],
                        title: url,
                        url: url
                    });
                }
                google.maps.event.addListener(marker, 'click', function() {
                    window.location.href = this.url;
                });                
            }
            label++;  
        }
        */
        
        
    }
 
}
</script>
</head>

<body>
<script type="text/javascript"
src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCyM0mrFrvnIbYkve4hWKY30cjVqY8VnMU&callback=initializeMap" async defer>
</script>
<div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>